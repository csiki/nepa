# ========================
NGPU=$(python -c "import torch; print(torch.cuda.device_count())")

MODEL_NAME="SixAILab/nepa-large-patch14-224-sft"
DATASET_PATH="/fast/imagenet-1k-hf"

DATALOADER_NUM_WORKERS=$((4 * NGPU))

# ========================
export HF_HUB_CACHE='/fast/hub'
export HF_DATASETS_CACHE='/fast/datasets'

# ========================
torchrun \
    --nproc_per_node $NGPU run_image_classification.py \
    \
    --ddp_backend nccl \
    --ddp_find_unused_parameters False \
    \
    --model_name_or_path $MODEL_NAME \
    --dataset_name $DATASET_PATH \
    --load_from_disk True \
    --do_eval True \
    --per_device_eval_batch_size 128 \
    --remove_unused_columns False \
    --crop_pct 0.95 \
    \
    --bf16 True \
    --dataloader_num_workers $DATALOADER_NUM_WORKERS \
    --dataloader_persistent_workers True \
    --dataloader_pin_memory False \